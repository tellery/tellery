syntax = "proto3";

package tellery.grpc;
option java_package = "io.tellery.grpc";
option java_outer_classname = "TelleryDbtProto";
option java_multiple_files = true;

import "google/protobuf/empty.proto";

service Dbt {
  rpc GenerateKeyPair (GenerateKeyPairRequest) returns (GenerateKeyPairResponse);
  rpc PullRepo (PullRepoRequest) returns (PullRepoResponse);
  rpc PushRepo (PushRepoRequest) returns (google.protobuf.Empty);
  rpc RefreshWorkspace (google.protobuf.Empty) returns (google.protobuf.Empty);
}

message GenerateKeyPairRequest {
  string profile = 1;
}

message GenerateKeyPairResponse {
  string publicKey = 1;
}

message PullRepoRequest {
  string profile = 1;
}

message PullRepoResponse {
  repeated DbtBlock blocks = 1;
}

message PushRepoRequest {
  string profile = 1;
  repeated QuestionBlockContent blocks = 2;
}

message DbtBlock {
  enum Type {
    UNSPECIFIED = 0;
    SOURCE = 1;
    MODEL = 2;
  }

  enum Materialization {
    UNKNOWN = 0;
    VIEW = 1;
    TABLE = 2;
    INCREMENTAL = 3;
    EPHEMERAL = 4;
  }

  Type type = 1;
  string name = 2;
  string uniqueId = 3;
  string description = 4;
  string relationName = 5;
  // Only for model
  string rawSql = 6;
  string compiledSql = 7;
  Materialization materialized = 8;
  // Only for source
  string sourceTable = 9;
}

message QuestionBlockContent {
  string name = 1;
  string sql = 2;
}
